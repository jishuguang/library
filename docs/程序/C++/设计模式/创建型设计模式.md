# 创建型设计模式

## Singleton

### 典型实现

```cpp
class Singleton {
public:
    static Singleton& Instance()
    {
        static Singleton singleton;
        return singleton;
    }

private:
    Singleton() { /* code */ }
    // 不支持拷贝/移动
    Singleton(const Singleton&) = delete;
    Singleton(Singleton&&) = delete;
    Singleton& operator=(const Singleton&) = delete;
    Singleton(Singleton&&) = delete;
};
```

```{note}
补充C++ static线程安全的说明及初始化时机；
补充分析非default-initialization的情况。
```

### 问题及规避

```{note}
单例的析构函数不可调用其它单例，因为单例之间的析构顺序没有约束。
```

可通过如下方式规避单例析构调用单例问题：

```cpp
public:
    static Singleton& Instance()
    {
        static Singleton* singleton = new Singleton();
        return *singleton;
    }
```

```{note}
补充分析单例降低可测试性，例如单例难以打桩。
```

```{note}
补充分析单例降低代码可重构性，例如散落各处的Sigleton::Instance()，如何通过依赖注入进行规避。
```

## Factory

### Factory Method

典型实现：

```cpp
class Product {
public:
    static Product FromA(int, int);
    static Product FromB(int, int);
protected:
    Product() {}  // 构造函数若不需要可不对外提供，以保持接口简单清晰（下同)
};
```

工厂方法相比C++构造函数的优势：

- 函数名自解释性强；
- 支持相同形参的不同构造方法。

### Simple Factory

#### 典型实现

```cpp
class Product {
    friend class ProductFactory;
private:
    Product() {}    
};

class ProductFactory {
public:
    static Product FromA(int, int);
    static Product FromB(int, int);
};
```

#### 内部类实现

```cpp
class Product {
public:
    class Factory {
    public:
        static Product FromA(int, int);
        static Product FromB(int, int);
    };
private:
    Product() {}
};
```

内部类实现相比典型实现更加内聚，但对于简单场景，内部类实现不如直接使用Factory Method。

### Abstract Factory

典型实现：

```cpp
class AbstractProduct;
class AbstractFactory {
public:
    virtual shared_ptr<AbstractProduct> From(int, int) = 0;
};

class ProductX: public AbstractProduct;
class XFactory: public AbstractFactory {
    shared_ptr<AbstractProduct> From(int, int) override;
}
```

```{note}
补充真实示例。
```

### Registry

#### 典型实现

```{note}
补充典型实现。
```

#### Functional Registry

```cpp
class Registry {
public:

private:
    map<string, function<shared_ptr<Product>()> registry;
};
```

```{note}
待完善。
```

## Builder

## Prototype

