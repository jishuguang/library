# 文件系统

## Overview

### Filesystem Types

Disk-based filesystem: FAT, EXT2/3, ...
Virtual filesystem: proc, ...
Network filesystem

### The Common File Model

Inodes
- elements
    - metadata
    - data segment
- entry elements
    - number
    - name

Links
- symbolic (soft)
- hard

Programing interface
- system call: open/close
- file descriptor
- struct file
- access mode

## Structure of the VFS

### Inode

struct inode (in memory)
- basic info
    - atime/mtime/ctime
    - size/blocks
    - ino/count/nlink
    - mode/uid/gid
- inode operations
    - i_op: create/lookup/link/mkdir/rename/getattr/...
    - i_fop

### Process-specific info

struct task_struct
- struct file_struct
    - struct file
        - struct path
        - struct file_operations
    - next_fd
    - struct fdtable
- struct fs_struct
    - umask
    - struct dentry: root/pwd/altroot
    - struct vfsmount: rootmnt/pwdmnt/altrootmnt
- struct nsproxy
    - struct mnt_namespace
        - struct vfsmount

### File operations

struct file_operations
- read/write
- open/release
- mmap
- ioctl
- poll
- lock
- ...

### dentry cache

struct dentry
- struct list_head d_subdirs
- struct inode
- struct qstr d_name/unsigned char d_iname
- struct dentry_operations: d_iput/d_compare/d_delete/d_release/d_hash
- struct super_block

Cache organization
- dentry_hashtable
- LRU list

Standard function
- dget/dput
- d_drop/d_delete
- d_instantiate/d_add
- d_alloc/d_alloc_anon
- d_lookup

## Working with VFS object

### Filesystem operations

Registering filesystem
- register_filesystem
- struct file_system_type
  - int fs_flags
  - char* name
  - get_sb/kill_sb/struct list_head fs_supers

Mounting and unmounting
- VFS mount structure
  - Single filesystem hierarchy
  - struct vfsmount
    - struct dentry *mnt_mountpoint
    - struct super_block *mnt_sb
    - mnt_parent/mnt_child
    - struct mnt_namespace
- Superblock management
    - struct super_block
      - blocksize
      - struct file_system_type* s_type
      - struct dentry* s_root
      - s_dev/s_bdev
      - s_dirty
      - s_files
      - struct super_operations
        - inode: read/dirty/delete/put/clear/alloc/destory
        - write_super/put_super
        - remount_fs/statfs/sync_fs
        - show_options/show_stats
- mount (system call)
  - sys_mount -> do_mount
    - do_new_mount (default)
      - do_kern_mount
      - do_add_mount
    - do_remount
    - ...
- Shared subtrees
  - MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE
- umount (system call)
  - sys_umount -> do_umount
- Automatic expiration
- Pseudo-Filesystem

### File Operations

Finding inodes
- path_lookup -> __link_path_walk
  - check permissions
  - do_lookup
  - do_follow_link
    - check link limits

Opening file
- open -> sys_open -> do_sys_open
  - do_flip_open: file inode
  - fd_install

Reading and writing
- read -> sys_read -> file.f_op.read/do_sync_read
- write -> sys_write -> file.f_op.write/do_sync_write

## Standard functions

### Generic read routine

do_sync_read
generic_file_aio_read -> do_generic_file_read -> do_generic_mapping_read

### The fault mechanism

filemap_fault

### Permission-Checking

permission

## Second extended filesystem

### Physical structure

Structure overview
- block group
  - super block
  - group descriptor
  - data bitmap/inode bitmap
  - inode table
  - data block
- hard disk
  - boot block
  - block group 0~n

Indirection
- inode
  - direct data block
  - indirect blocks
    - data blocks

Fragmentation

### Data structure

struct ext2_super_block
- s_log_block_size
- s_blocks/inodes_per_group
- s_def_resuid/resgid
- s_state/s_lastcheck/s_checkinterval
- s_feature_compat/incompat/ro_compat

struct ext2_group_desc
- bg_block/inode_bitmap
- bg_free_blocks/inodes_count

struct ext2_inode

struct ext2_dir_entry_2
- inode
- rec_len
- file_type: EXT2_FT_UNKNOWN/REG_FILE/DIR/CHRDEV/BLKDEV/FIFO/SOCK/SYMLINK

Data structure in memory
- struct ext2_sb_info
- pre-allocation
  - struct ext2_reserve_window

### Create a filesystem

mke2fs

### Filesystem actions

overview
- ext2_file_operations
- ext2_dir_operations
- ext2_file_inode_operations
- ext2_dir_inode_operations
- ext2_aops (address_space_operations)
- ext2_sops (super_operations)

Mounting and unmounting
- struct file_system_type ext2_fs_type
  - get_sb: ext2_get_sb -> get_sb_bdev
  - kill_sb

Reading and generating data and indirection blocks
- finding data blocks: get_block_t
- requesting new block
- block allocation
- pre-allocation handling
- creating new reservations

Creating and deleting inodes
- ext2_create -> ext2_new_inode
- ext2_mkdir -> ext2_new_inode
- registering inodes
  - inode distribution strategy
    - (default) Orlov allocation (dir)
    - classic allocation (dir)
    - inode allocation for regular file
- ext2_rmdir
- ext2_unlink
- ext2_delete_inode -> ext2_truncate/ext2_free_inode

Address space operations

## Third extended filesystem

new feature
- transaction and journal
  - atomic handle
    - log record

data structure
- struct task_structure
  - void* journal_info
- struct handle_s
- struct transation_s

## Filesystem without persistent storage
